#!/bin/bash

# TaskDriver CLI End-to-End Test
# Tests the complete workflow from project creation to task completion
# 
# Note: Test patterns use flexible matching (‚úÖ + key terms) rather than exact 
# wording to reduce brittleness when output messages change

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Test configuration
PROJECT_NAME="e2e-test-project"
PROJECT_DESC="End-to-end test project for CLI validation"
TASK_TYPE_NAME="file-processor"
AGENT_NAME="test-worker"
CLI_CMD="bun run src/cli.ts"
TEST_DIR="./test-e2e-data"

echo -e "${BLUE}üß™ Starting TaskDriver CLI End-to-End Test${NC}"
echo "========================================"

# Cleanup function
cleanup() {
    echo -e "${YELLOW}üßπ Cleaning up test data...${NC}"
    rm -rf "$TEST_DIR" ./data 2>/dev/null || true
}

# Set trap to cleanup on exit
trap cleanup EXIT

# Step 1: Clean environment and health check
echo -e "\n${BLUE}Step 1: Environment Setup${NC}"
cleanup
echo "‚úì Cleaned test environment"

echo -e "\nüîç Checking system health..."
if ! $CLI_CMD health-check; then
    echo -e "${RED}‚ùå Health check failed${NC}"
    exit 1
fi
echo "‚úì System is healthy"

# Step 2: Create project
echo -e "\n${BLUE}Step 2: Project Creation${NC}"
echo "üèóÔ∏è  Creating project '$PROJECT_NAME'..."
PROJECT_OUTPUT=$($CLI_CMD create-project "$PROJECT_NAME" "$PROJECT_DESC" --instructions "Process files efficiently. Remove PII. Follow security protocols." --max-retries 2 --lease-duration 5)
if [[ $PROJECT_OUTPUT == *"‚úÖ"* && $PROJECT_OUTPUT == *"$PROJECT_NAME"* && $PROJECT_OUTPUT == *"Instructions:"* ]]; then
    echo "‚úì Project created successfully (includes instructions)"
else
    echo -e "${RED}‚ùå Project creation failed or missing instructions${NC}"
    echo "Expected: ‚úÖ success message, project name, and Instructions: section"
    echo "Actual output:"
    echo "$PROJECT_OUTPUT"
    exit 1
fi

# Extract project ID from output - updated for new format
PROJECT_ID=$(echo "$PROJECT_OUTPUT" | grep -o '[a-f0-9\-]\{36\}' | head -1)
echo "‚úì Project ID: $PROJECT_ID"

# Step 3: List projects and verify
echo -e "\nüîç Verifying project in list..."
LIST_OUTPUT=$($CLI_CMD list-projects)
if [[ $LIST_OUTPUT == *"$PROJECT_NAME"* ]]; then
    echo "‚úì Project appears in list"
else
    echo -e "${RED}‚ùå Project not found in list${NC}"
    echo "$LIST_OUTPUT"
    exit 1
fi

# Step 4: Get project details
echo -e "\nüîç Getting project details..."
PROJECT_DETAILS=$($CLI_CMD get-project "$PROJECT_NAME")
if [[ $PROJECT_DETAILS == *"$PROJECT_NAME"* ]] && [[ $PROJECT_DETAILS == *"Total Tasks: 0"* ]] && [[ $PROJECT_DETAILS == *"Status:"* ]] && [[ $PROJECT_DETAILS == *"Configuration:"* ]] && [[ $PROJECT_DETAILS == *"Statistics:"* ]] && [[ $PROJECT_DETAILS == *"Instructions:"* ]] && [[ $PROJECT_DETAILS == *"Process files efficiently"* ]]; then
    echo "‚úì Project details correct (includes status, config, stats, and instructions)"
else
    echo -e "${RED}‚ùå Project details incorrect - missing critical sections${NC}"
    echo "Expected sections: Status, Configuration, Statistics, Instructions"
    echo "Expected instructions content: 'Process files efficiently'"
    echo "Actual output:"
    echo "$PROJECT_DETAILS"
    exit 1
fi

# Step 5: Create task type
echo -e "\n${BLUE}Step 3: Task Type Creation${NC}"
echo "üìù Creating task type '$TASK_TYPE_NAME'..."
TASK_TYPE_OUTPUT=$($CLI_CMD create-task-type "$PROJECT_NAME" "$TASK_TYPE_NAME" \
    --template "Process {{filename}} with {{method}}" \
    --vars filename method \
    --duplicate-handling ignore \
    --max-retries 3 \
    --lease-duration 8)

if [[ $TASK_TYPE_OUTPUT == *"‚úÖ"* ]]; then
    echo "‚úì Task type created successfully"
else
    echo -e "${RED}‚ùå Task type creation failed${NC}"
    echo "$TASK_TYPE_OUTPUT"
    exit 1
fi

# Extract task type ID
TASK_TYPE_ID=$(echo "$TASK_TYPE_OUTPUT" | grep -o '[a-f0-9\-]\{36\}' | head -1)
echo "‚úì Task Type ID: $TASK_TYPE_ID"

# Step 6: List task types
echo -e "\nüîç Verifying task type in list..."
TASK_TYPE_LIST=$($CLI_CMD list-task-types "$PROJECT_NAME")
if [[ $TASK_TYPE_LIST == *"$TASK_TYPE_NAME"* ]]; then
    echo "‚úì Task type appears in list"
else
    echo -e "${RED}‚ùå Task type not found in list${NC}"
    echo "$TASK_TYPE_LIST"
    exit 1
fi

# Step 7: Agent Name Setup (no registration needed in lease-based model)
echo -e "\n${BLUE}Step 4: Agent Setup${NC}"
echo "ü§ñ Setting up agent name '$AGENT_NAME'..."
echo "‚úì Agent name prepared (no registration needed in lease-based model)"
echo "‚úì Agents are ephemeral queue workers in the new architecture"

# Step 8: Create multiple tasks
echo -e "\n${BLUE}Step 5: Task Creation${NC}"
echo "üìã Creating multiple tasks..."

TASK_IDS=()

# Create task 1
echo "üìã Creating task 1..."
TASK1_OUTPUT=$($CLI_CMD create-task "$PROJECT_NAME" "$TASK_TYPE_ID" "Process document.pdf" \
    --vars '{"filename": "document.pdf", "method": "OCR"}')
TASK1_ID=$(echo "$TASK1_OUTPUT" | grep "Task:" | sed 's/Task: //' | head -1)
TASK_IDS+=("$TASK1_ID")
echo "‚úì Task 1 ID: $TASK1_ID"

# Create task 2
echo "üìã Creating task 2..."
TASK2_OUTPUT=$($CLI_CMD create-task "$PROJECT_NAME" "$TASK_TYPE_ID" "Process image.png" \
    --vars '{"filename": "image.png", "method": "compression"}')
TASK2_ID=$(echo "$TASK2_OUTPUT" | grep "Task:" | sed 's/Task: //' | head -1)
TASK_IDS+=("$TASK2_ID")
echo "‚úì Task 2 ID: $TASK2_ID"

# Create task 3
echo "üìã Creating task 3..."
TASK3_OUTPUT=$($CLI_CMD create-task "$PROJECT_NAME" "$TASK_TYPE_ID" "Process data.csv" \
    --vars '{"filename": "data.csv", "method": "validation"}')
TASK3_ID=$(echo "$TASK3_OUTPUT" | grep "Task:" | sed 's/Task: //' | head -1)
TASK_IDS+=("$TASK3_ID")
echo "‚úì Task 3 ID: $TASK3_ID"

# Step 9: List tasks and verify
echo -e "\nüîç Verifying tasks in list..."
TASK_LIST=$($CLI_CMD list-tasks "$PROJECT_NAME")
QUEUED_COUNT=$(echo "$TASK_LIST" | grep -c "queued" || true)
if [[ $QUEUED_COUNT -eq 3 ]]; then
    echo "‚úì All 3 tasks are queued"
else
    echo -e "${RED}‚ùå Expected 3 queued tasks, found $QUEUED_COUNT${NC}"
    echo "$TASK_LIST"
    exit 1
fi

# Step 10: Agent workflow - process all tasks
echo -e "\n${BLUE}Step 6: Agent Task Processing${NC}"

for i in {1..3}; do
    echo -e "\nü§ñ Processing task $i..."
    
    # Get next task
    echo "üì• Getting next task for agent..."
    NEXT_TASK_OUTPUT=$($CLI_CMD get-next-task "$PROJECT_NAME" "$AGENT_NAME")
    
    if [[ $NEXT_TASK_OUTPUT == *"‚úÖ"* && $NEXT_TASK_OUTPUT == *"task"* ]]; then
        echo "‚úì Task assigned to agent"
    elif [[ $NEXT_TASK_OUTPUT == *"No tasks"* || $NEXT_TASK_OUTPUT == *"no tasks"* ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No more tasks available${NC}"
        break
    else
        echo -e "${RED}‚ùå Failed to get next task${NC}"
        echo "$NEXT_TASK_OUTPUT"
        exit 1
    fi
    
    # Extract assigned task ID
    ASSIGNED_TASK_ID=$(echo "$NEXT_TASK_OUTPUT" | grep '"id":' | sed 's/.*"id": "\([^"]*\)".*/\1/')
    echo "‚úì Assigned Task ID: $ASSIGNED_TASK_ID"
    
    # Simulate some processing time
    echo "‚è≥ Simulating task processing (2 seconds)..."
    sleep 2
    
    # Complete the task
    echo "‚úÖ Completing task..."
    COMPLETE_OUTPUT=$($CLI_CMD complete-task "$AGENT_NAME" "$PROJECT_NAME" "$ASSIGNED_TASK_ID" \
        "{\"success\": true, \"output\": \"Task $i completed successfully\", \"processingTime\": \"2s\"}")
    
    if [[ $COMPLETE_OUTPUT == *"‚úÖ"* && $COMPLETE_OUTPUT == *"completed"* ]]; then
        echo "‚úì Task $i completed successfully"
    else
        echo -e "${RED}‚ùå Task completion failed${NC}"
        echo "$COMPLETE_OUTPUT"
        exit 1
    fi
done

# Step 11: Verify final state
echo -e "\n${BLUE}Step 7: Final Verification${NC}"

echo "üìä Getting final project statistics..."
FINAL_STATS=$($CLI_CMD get-project-stats "$PROJECT_NAME")
if [[ $FINAL_STATS == *"Total Tasks: 3"* && $FINAL_STATS == *"Completed: 3"* ]]; then
    echo "‚úì All tasks completed successfully"
else
    echo -e "${RED}‚ùå Final statistics incorrect${NC}"
    echo "$FINAL_STATS"
    exit 1
fi

echo -e "\nüîç Checking final task list..."
FINAL_TASK_LIST=$($CLI_CMD list-tasks "$PROJECT_NAME")
COMPLETED_COUNT=$(echo "$FINAL_TASK_LIST" | grep -c "completed" || true)
if [[ $COMPLETED_COUNT -eq 3 ]]; then
    echo "‚úì All 3 tasks show as completed"
else
    echo -e "${RED}‚ùå Expected 3 completed tasks, found $COMPLETED_COUNT${NC}"
    echo "$FINAL_TASK_LIST"
    exit 1
fi

# Step 12: Test error scenarios
echo -e "\n${BLUE}Step 8: Error Handling Tests${NC}"

echo "üîç Testing duplicate task handling..."
DUPLICATE_OUTPUT=$($CLI_CMD create-task "$PROJECT_NAME" "$TASK_TYPE_ID" "Process document.pdf again" \
    --vars '{"filename": "document.pdf", "method": "OCR"}' 2>&1 || true)

# Since duplicate handling is set to 'ignore', this should succeed and return existing task
if [[ $DUPLICATE_OUTPUT == *"Task:"* ]]; then
    echo "‚úì Duplicate handling working correctly"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Duplicate handling test result: $DUPLICATE_OUTPUT${NC}"
fi

echo "üîç Testing invalid project access..."
INVALID_PROJECT_OUTPUT=$($CLI_CMD get-project "non-existent-project" 2>&1 || true)
if [[ $INVALID_PROJECT_OUTPUT == *"not found"* || $INVALID_PROJECT_OUTPUT == *"‚ùå"* ]]; then
    echo "‚úì Invalid project handling working correctly"
else
    echo -e "${RED}‚ùå Invalid project should have failed${NC}"
    exit 1
fi

# Step 13: Test lease management
echo -e "\n${BLUE}Step 9: Lease Management Test${NC}"

echo "üßπ Testing lease cleanup..."
CLEANUP_OUTPUT=$($CLI_CMD cleanup-leases "$PROJECT_NAME")
if [[ $CLEANUP_OUTPUT == *"‚úÖ"* ]]; then
    echo "‚úì Lease cleanup working correctly"
else
    echo -e "${RED}‚ùå Lease cleanup failed${NC}"
    echo "$CLEANUP_OUTPUT"
    exit 1
fi

# Final success message
echo -e "\n${GREEN}üéâ ALL TESTS PASSED!${NC}"
echo "========================================"
echo -e "${GREEN}‚úÖ End-to-End CLI Test Completed Successfully${NC}"
echo ""
echo "üìä Test Summary:"
echo "  ‚Ä¢ Project created and managed ‚úì"
echo "  ‚Ä¢ Task type created with templates ‚úì"
echo "  ‚Ä¢ Agent setup (lease-based model) ‚úì"
echo "  ‚Ä¢ 3 tasks created and processed ‚úì"
echo "  ‚Ä¢ Complete agent workflow tested ‚úì"
echo "  ‚Ä¢ Statistics and monitoring verified ‚úì"
echo "  ‚Ä¢ Error handling validated ‚úì"
echo "  ‚Ä¢ Lease management tested ‚úì"
echo ""
echo -e "${BLUE}üöÄ TaskDriver CLI is fully functional!${NC}"